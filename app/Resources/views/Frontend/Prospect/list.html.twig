{% extends '::base.html.twig' %}
{% import ":Frontend/Macros/Prospect:photoDisplay175.html.twig" as photoDisplayIndex %}
{% block title %}Contacts{% endblock %}

{% set csrfDelete = csrf_token('delete') %}

{% block content %}
    <div class="container" id="container-prospect">        
        <section class="page-title">
            <h1>Contacts</h1> 
        </section>
        <div class="page-title-underline"></div> 

        <div class="page-nav">
            <a class="btn-basic-ico" href="#" id="add_prospect" title ="{{ 'app.contact.list.add'|trans }}"><i class="icon ion-ios-plus-empty"></i><span>{{ 'app.contact.list.add'|trans }}</span></a>
        </div>
        
        {% for prospect in pagination %}
            <div class="prospect-record row" id="{{ prospect.id }}">
                <div class="row row-info">
                    <div class="prospect-record-photo col-md-2">
                        {{ photoDisplayIndex.primaryPhoto(prospect.photos) }}                     
                    </div>
                    <div class="prospect-record-card col-md-10">
                        {% if prospect.country != null %}
                            {% set lang = prospect.country|capitalize %}
                            <img class="list-flag" src="{{ asset('bundles/app/images/flags/' ~ lang ~ '.png') }}" />
                        {% endif %}
                        <div class="record-firstname">{{ prospect.firstname }} {{ prospect.lastname }}, {{ prospect.age }}</div>               
                                           
                    </div>
                </div>                 
                
                <div class="row row-actions">                    
                    <ul class="record-actions"> 
                        <li><p>Encounters</p></li>
                        <li>
                            <a class="custom-tooltip" href="{{ path('encounter', {'prospect_id': prospect.id}) }}" title="Add encounters"  data-toggle="tooltip" data-placement="top"><i class="icon ion-ios-wineglass-outline"></i></a>
                        </li>
                        <li class="separator"></li>
                        <li><p>Ratings</p></li>
                        <li>
                            <a class="custom-tooltip" href="{{ path('rating_edit', {'prospect_id': prospect.id}) }}" title="Rate this contact"  data-toggle="tooltip" data-placement="top"><i class="icon ion-ios-star-outline"></i></a>
                        </li>
                        <li class="separator"></li>
                        <li><p>Gallery</p></li>
                        <li>
                            <a class="custom-tooltip" href="{{ path('gallery', {'prospect_id': prospect.id}) }}" title="Add and remove photos"  data-toggle="tooltip" data-placement="top"><i class="icon ion-ios-albums-outline"></i></a>
                        </li>
                        <li class="separator"></li>
                        <li><p>Relationship</p></li>
                        <li>
                            <a class="custom-tooltip" href="{{ path('relationship_show', {'id': prospect.relationship.id}) }}" title="Show relationship" data-toggle="tooltip" data-placement="top"><i class="icon ion-ios-eye-outline"></i></a>
                        </li>
                        <li>
                            <a class="edit-relationship custom-tooltip" data-id="{{ prospect.relationship.id }}" href="{{ path('relationship_edit', {'id': prospect.relationship.id}) }}" title="Edit relationship" data-toggle="tooltip" data-placement="top"><i class="icon ion-ios-compose-outline"></i></a>
                        </li>
                        <li class="separator"></li>
                        <li><p>Contact</p></li>
                        <li>
                            <a class="custom-tooltip" href="{{ path('prospect_show', { 'id': prospect.id }) }}" title="Show all contact infos" data-toggle="tooltip" data-placement="top"><i class="icon ion-ios-search"></i></a>
                        </li>
                        <li>
                            <a class="edit_prospect custom-tooltip" href="#" data-id="{{ prospect.id }}" title="Modify contact" data-toggle="tooltip" data-placement="top"><i class="icon ion-ios-compose-outline"></i></a>
                        </li>
                        <li>
                            <a href="#" class="delete custom-tooltip" data-id="{{ prospect.id }}" title="Delete contact"  data-toggle="tooltip" data-placement="top"><i class="icon ion-ios-trash-outline"></i></a>
                        </li>
                    </ul>                    
                </div>               
            </div>
        {% endfor %}
        
        <div class="navigation pull-right">
            {{ knp_pagination_render(pagination) }}
        </div>
         
            
        {# Modales #}
        <div class="modal fade modal-full" id="modal_prospect_form" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg modal-dialog-scroll">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true"><i class="icon ion-ios-close-empty"></i></span>
                        </button>
                        <h2 class="modal-title"></h2>
                    </div>    
                    <div class="modal-body" id="modal_prospect_form_body">
                        {# Form returned by ajax #}
                    </div>                       
                </div>    
            </div>
        </div>

        {# POPUP OVERLAY D'ATTENTE AJAX #}
        <div class="overlay"></div>
        <div class="loader_standard">
            <p>Loading...</p>
        </div>
    </div> 

    {% block javascript %}
        {% javascripts 
            'bundles/app/js/prospect_index.js'
        %}
            <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
    {% endblock %}
    
    <script type="text/javascript">
        $(document).ready(function(){          
            
            var locale = "{{ app.request.locale }}";      
           
            $('[data-toggle="tooltip"]').tooltip();            
                   
            // Ajax: get form new prospect
            $("#add_prospect").click(function(event){
                event.preventDefault();                
     
                $(".loader_standard").show();
              
                var url = Routing.generate('ajax_new_prospect_form', {'_locale': locale});
                
                $.get(url, function(response){                   
                    $(".modal-body").html(response); // coller la vue dans une modale  
                    
                    $(".loader_standard").hide(200, function(){});                                     
                    
                    $(".modal-title").text("New contact");
                    $('.modal-full').modal('show');
                });
            });
            
            // Ajax: get form edit prospect
            $(".record-actions").on("click", ".edit_prospect", function(event){
                event.preventDefault();               
                
                $(".loader_standard").show();
            
                var id = $(this).data("id");                
                var url = Routing.generate('ajax_edit_prospect_form', {'id':id, '_locale': locale});
                
                $.get(url, function(response){                   
                    $(".modal-body").html(response);                    
                    
                    $(".loader_standard").hide(200, function(){});                                     
                    
                    $(".modal-title").text("Edit contact");
                    $('.modal-full').modal('show');
                });
            });
            
            $('.modal-full').on('hidden.bs.modal', function (e) {
                $(".modal-body").empty();
                $(".modal-title").empty();
            });
            
            // Ajax: get form edit relationship
            $(".record-actions").on("click", ".edit-relationship", function(event){
                event.preventDefault();               
                
                $(".loader_standard").show();
            
                var id = $(this).data("id");                
                var url = Routing.generate('ajax_edit_relationship_form', {'id':id, '_locale': locale});
                
                $.get(url, function(response){                   
                    $(".modal-body").html(response);                    
                    
                    $(".loader_standard").hide(200, function(){});                                     
                    
                    $(".modal-title").text("Edit relationship");
                    $('.modal-full').modal('show');
                });
            });
            
            $('.modal-full').on('hidden.bs.modal', function (e) {
                $(".modal-body").empty();
                $(".modal-title").empty();
            });
            
            
            
            
            
            $(".record-actions").on("click", ".delete", function(event){
                event.preventDefault();
                
                var prospect_id = $(this).data("id");                
                
                $.confirm({
                    animation: 'zoom',
                    animationBounce: 1,
                    confirm: function(){
                        ajaxDeleteProspect(prospect_id);
                    },
                    cancel: function(){
                        console.log('the user clicked cancel');
                    }
                });
            });
            
            /**
             * Deletes a prospect with ajax
             * 
             * @param {int} prospect_id
             * @returns {undefined}
             */
            function ajaxDeleteProspect(prospect_id)
            {                
                var url = Routing.generate('ajax_delete_prospect', {'id': prospect_id, '_locale': locale});  
                var csrfDelete = "{{ csrfDelete }}";
                var data = {'csrfDelete': csrfDelete};

                $.post(url, data, function(response){

                    var data = $.parseJSON(response);
                    var id = data.id;
                                       
                    $("#"+id).remove(); // Remove contact row
                });
            }
            
        });
    </script>
{% endblock %}
